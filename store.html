<script>

Vue.use(Vuex);

var store = new Vuex.Store ({
  state: {
    ui: {dialog: false,
         colors: {tagList: { light: [ "teal", "green", "light-green", "grey", "blue-grey", "indigo"],
                             dark:  ["green", "grey", "orange", "lime", "amber", "deep-orange"]},
                  theme: "light"
                  },
         footer: '',
         unreadType: [{color: "blue lighten-3", tooltip: "помечена непрочитанной"}, 
                      {color: "success", tooltip: "новая"}, 
                      {color: "info", tooltip: "обновлена"}, 
                      {color: "warning", tooltip: "редактирована"},
                      {color: "error", tooltip: "редактор заблокировал"}]
         },
     profile: {},
     ls: {db: undefined,
          config: '',
          dbStructure: 
            [{ name: "news",
                tables: [
                { name: "news",
                    fields: 
                      ["id","title","idsource","rating","date","time","link",
                      "last_edited","paragraphs","references","tags", "rubrics"]
                }]
             },
              { name: "news_config",
                tables: [
                { name: "unread", fields: ["id","type"]}
                  ]
             },
              { name: "refs",
                  tables: [
                    { name: "version", fields: ['id', 'v_local', 'v_server', 'id_local', 'id_server'] },
                    { name: "rubric", fields: ['id', 'nm'] },
                    { name: "status", fields: ['id', 'nm'] },
                    { name: "tag", fields: ['id', 'nm', 'tp'] },
                    { name: "tag_type", fields: ['id', 'nm'] },
                    { name: "source", fields: ['id', 'nm'] }
                  ]
                }
             ]
          },
    },
  getters: {
    ls (state) {  
       return state.ls;
       },
    profile (state) {  
       return state.profile;
       },
    ui (state) {  
       return state.ui;
       },
    colorsTagList (state) {  
       return (state.ui.colors.theme === "light") 
          ? state.ui.colors.tagList.light 
          : state.ui.colors.tagList.dark
       },
  },
  mutations: {
     setProfile (state, profile) {  
       state.profile = profile;
     },
     setLsDb (state, connections) {  
       state.ls.db = connections;
     },
     setFooter (state, msg) {  
       state.ui.footer = msg;
     },
     setObjReactive (state, obj) {      
       Vue.set(obj, 'setObjReactive', 42); /* принудительное обновление объекта для реактивности*/
       Vue.delete(obj, 'setObjReactive');
      },
  },
  actions: {
    startLocalDb ({commit, dispatch, getters}) {
      const tablesRef = getters.ls.dbStructure[_.findIndex(getters.ls.dbStructure, ['name', 'refs'])].tables;
      ls_async_OpenDb(getters.ls.dbStructure)
      // Сохраняем ссылку на коннект к базе
        .then((connections) => {
           commit('setLsDb', connections);
           console.log ("startLocalDb - 1");
           })
      // читаем локальные справочники с диска в память
        .then(() => {
           console.log ("readRefs - 5");
           return dispatch("readRefs", tablesRef);
           }) 
      // читаем локальные новости с диска в память и создаем индекс непрочитанных новостей
        .then(() => {
           console.log ("readNews - 2");
           return dispatch("readNews");
           })     
      // получаем профайл пользователя
         .then(() => {  
           return callGasSriptAsPromise().apiGetUserProfile()
             .then((profile) => {
               commit('setProfile', profile);
               console.log ("apiGetUserProfile", profile);
               });
            })
      // получаем актуальные номера версий с сервера
//         .then(() => {  
//           console.log ("apiGetRef - 6");
//           const request = {name: "version"};
//           if (getters.version["version"]) request.param = {version: getters.version["version"].v_server}; 
//           // если массив версий на локальном диске пуст - иницализируем его в памяти
//           else {
//             const result = [];
//             _.forEach(tablesRef, function({name}) {
//               if (name) result.push({id: name, v_local: 0, v_server: 0, id_local: 0, id_server: 0});  
//             });
//             dispatch("setRefByName", { data: result, name: "version" });
//           }
//           return callGasSriptAsPromise().apiGetRef(request);
//            })
//       // обновляем локальную таблицу версий в памяти
//        .then((result) => {
//           console.log ("setVersion - 7");
//           if (result.length) dispatch("setVersion", result);
//           else console.error('apiGetRef({ name: "version"})', 'Cервер не вернул таблицу версий');
//           })
       // обновляем в пямяти справочники с сервера с учетом версий
        .then(() => {
           _.forEach(getters.version, function({id}) {
               if (id) dispatch("loadRefByName", id);  
             });
             console.log ("loadRefByName - 8");
           })            
//       // получаем актуальные новости с сервера
//        .then(() => {
//           dispatch("reloadNews");
//           console.log ("reloadNews - 9");
//           })
//        // Просим сервер обновить данные по новостям
//        .then(() => {
//          dispatch("uploadServer");
//          console.log ("uploadServer - 4");
//           })  
        .catch((error) => {
           commit('setFooter', "Локальные данные прочесть не удалось");
           console.error('ls_async_OpenDb', error);
           });     
      },
    updateLocalDb ({commit, dispatch, getters}) {      
      if (!getters.ls.db) {
        console.error('updateLocalDb', 'Локальная база данных не рабоает');
        return;
        }
      },
  }, 
  modules: {
     news,
     refs,
  }
});
console.log ("store started");
</script>